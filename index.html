<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spyfall - Multiplayer Game</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: #2c3e50;
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        padding: 30px;
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 32px;
        text-align: center;
      }

      h2 {
        color: #34495e;
        font-size: 20px;
        margin-bottom: 15px;
      }

      .subtitle {
        text-align: center;
        color: #7f8c8d;
        margin-bottom: 30px;
      }

      input[type="text"],
      input[type="number"] {
        width: 100%;
        padding: 14px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        margin-bottom: 15px;
        transition: border-color 0.3s;
      }

      input[type="text"]:focus,
      input[type="number"]:focus {
        outline: none;
        border-color: #3498db;
      }

      button {
        width: 100%;
        padding: 14px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
        margin-bottom: 10px;
      }

      button:hover:not(:disabled) {
        background: #2980b9;
      }

      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      button.secondary {
        background: #95a5a6;
      }

      button.secondary:hover:not(:disabled) {
        background: #7f8c8d;
      }

      button.danger {
        background: #e74c3c;
      }

      button.danger:hover:not(:disabled) {
        background: #c0392b;
      }

      button.success {
        background: #27ae60;
      }

      button.success:hover:not(:disabled) {
        background: #229954;
      }

      .hidden {
        display: none !important;
      }

      /* Room list */
      .room-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
      }

      .room-item {
        padding: 15px;
        background: #ecf0f1;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .room-info h3 {
        font-size: 18px;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .room-info p {
        font-size: 14px;
        color: #7f8c8d;
      }

      .room-item button {
        width: auto;
        padding: 10px 20px;
        margin: 0;
      }

      /* Player list */
      .player-list {
        background: #ecf0f1;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .player {
        padding: 12px;
        background: white;
        border-radius: 6px;
        margin-bottom: 8px;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .player.host::after {
        content: "üëë";
        margin-left: 10px;
      }

      .player .player-name {
        flex: 1;
      }

      .player .remove-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: background 0.3s;
      }

      .player .remove-btn:hover {
        background: #c0392b;
      }

      /* Role card */
      .role-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
      }

      .role-card.spy {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      }

      .role-card h2 {
        color: white;
        font-size: 28px;
        margin-bottom: 10px;
      }

      .role-card p {
        font-size: 20px;
        margin: 10px 0;
      }

      /* Location grid */
      .locations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
      }

      .location {
        padding: 12px;
        background: #ecf0f1;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        font-weight: 500;
      }

      .location:hover {
        background: #d5dbdb;
      }

      .location.crossed {
        background: #e74c3c;
        color: white;
        text-decoration: line-through;
        opacity: 0.6;
      }

      /* Timer */
      .timer-section {
        background: #34495e;
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
      }

      .timer-display {
        font-size: 48px;
        font-weight: bold;
        margin-bottom: 15px;
        font-family: "Courier New", monospace;
      }

      .timer-controls {
        display: flex;
        gap: 10px;
      }

      .timer-controls button {
        flex: 1;
      }

      /* Settings */
      .settings-group {
        margin-bottom: 20px;
      }

      .settings-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: #2c3e50;
      }

      /* Status messages */
      .status-message {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 500;
      }

      .status-message.info {
        background: #d6eaf8;
        color: #1f618d;
      }

      .status-message.success {
        background: #d5f4e6;
        color: #0e6655;
      }

      .status-message.warning {
        background: #fcf3cf;
        color: #7d6608;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- HOME SCREEN -->
      <div id="homeScreen">
        <h1>üïµÔ∏è Spyfall</h1>
        <p class="subtitle">Find the spy among you!</p>

        <div class="settings-group">
          <label for="usernameInput">Your Name</label>
          <input type="text" id="usernameInput" placeholder="Enter your name" />
        </div>

        <button id="createRoomBtn" disabled>Create New Room</button>

        <div style="text-align: center; margin: 20px 0; color: #7f8c8d">OR</div>

        <h2>Join Existing Room</h2>
        <div id="roomList" class="room-list">
          <div class="status-message info">Loading rooms...</div>
        </div>
      </div>

      <!-- LOBBY SCREEN -->
      <div id="lobbyScreen" class="hidden">
        <h1>üïµÔ∏è Spyfall</h1>
        <p class="subtitle" id="roomName">Room Name</p>

        <h2>Players in Lobby</h2>
        <div id="playerList" class="player-list"></div>

        <div class="settings-group">
          <label for="gameDuration">Game Duration (minutes)</label>
          <input type="number" id="gameDuration" value="8" min="1" max="30" />
        </div>
        <button id="startGameBtn" class="success">Start Game</button>

        <button id="leaveLobbyBtn" class="danger">Leave Room</button>
      </div>

      <!-- GAME SCREEN -->
      <div id="gameScreen" class="hidden">
        <h1>üïµÔ∏è Spyfall</h1>

        <!-- Role Card -->
        <div id="roleCard" class="role-card"></div>

        <!-- Players -->
        <h2>Players</h2>
        <div id="gamePlayers" class="player-list"></div>

        <!-- Timer -->
        <div class="timer-section">
          <div class="timer-display" id="timerDisplay">8:00</div>
          <div class="timer-controls">
            <button id="startTimerBtn" class="success">Start Timer</button>
            <button id="stopTimerBtn" class="secondary">Stop Timer</button>
          </div>
        </div>

        <!-- Locations -->
        <h2>Game Locations (<span id="locationCount">27</span>)</h2>
        <div id="locationsGrid" class="locations-grid"></div>

        <button id="endGameBtn" class="danger">End Game</button>
      </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- Game Data -->
    <script src="game-data.js"></script>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDBQWubzgtbljvlq_7Nfmturg3_4Nhauh0",
        authDomain: "spygame-fa5d0.firebaseapp.com",
        databaseURL: "https://spygame-fa5d0-default-rtdb.firebaseio.com",
        projectId: "spygame-fa5d0",
        storageBucket: "spygame-fa5d0.firebasestorage.app",
        messagingSenderId: "1031471679689",
        appId: "1:1031471679689:web:e61361fe2f2a2079efa518",
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const roomsRef = database.ref("rooms");

      // Global state
      let myPeerId = null;
      let myUsername = null;
      let currentRoomId = null;
      let isHost = false;
      let timerInterval = null;
      let timerSeconds = 0;
      let gameState = null;
      let allPlayers = {};

      // DOM elements
      const homeScreen = document.getElementById("homeScreen");
      const lobbyScreen = document.getElementById("lobbyScreen");
      const gameScreen = document.getElementById("gameScreen");
      const usernameInput = document.getElementById("usernameInput");
      const createRoomBtn = document.getElementById("createRoomBtn");
      const roomList = document.getElementById("roomList");
      const playerList = document.getElementById("playerList");
      const gamePlayers = document.getElementById("gamePlayers");
      const startGameBtn = document.getElementById("startGameBtn");
      const leaveLobbyBtn = document.getElementById("leaveLobbyBtn");
      const gameDuration = document.getElementById("gameDuration");
      const roleCard = document.getElementById("roleCard");
      const locationsGrid = document.getElementById("locationsGrid");
      const locationCount = document.getElementById("locationCount");
      const timerDisplay = document.getElementById("timerDisplay");
      const startTimerBtn = document.getElementById("startTimerBtn");
      const stopTimerBtn = document.getElementById("stopTimerBtn");
      const endGameBtn = document.getElementById("endGameBtn");
      const roomName = document.getElementById("roomName");

      // Initialize app
      function initApp() {
        myPeerId =
          "user_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
        createRoomBtn.disabled = false;
        loadRooms();
      }

      // Enable create button when username is entered
      usernameInput.addEventListener("input", () => {
        if (usernameInput.value.trim() && myPeerId) {
          createRoomBtn.disabled = false;
        } else {
          createRoomBtn.disabled = true;
        }
      });

      // Create room
      createRoomBtn.addEventListener("click", () => {
        const username = usernameInput.value.trim();
        if (!username) {
          alert("Please enter your name");
          return;
        }

        myUsername = username;
        const roomId = "room_" + Date.now();
        currentRoomId = roomId;
        isHost = true;

        const roomData = {
          name: username + "'s Room",
          hostPeerId: myPeerId,
          hostName: username,
          createdAt: Date.now(),
          players: {
            [myPeerId]: {
              name: username,
              peerId: myPeerId,
              isHost: true,
            },
          },
          gameStarted: false,
        };

        roomsRef
          .child(roomId)
          .set(roomData)
          .then(() => {
            // Set presence tracking
            const playerPresenceRef = roomsRef
              .child(roomId)
              .child("players")
              .child(myPeerId)
              .child("connected");
            playerPresenceRef.set(true);
            playerPresenceRef.onDisconnect().set(false);

            showLobby();
            watchRoom();
          })
          .catch((error) => {
            console.error("Error creating room:", error);
            alert("Failed to create room");
          });
      });

      // Load rooms
      function loadRooms() {
        roomsRef.on("value", (snapshot) => {
          const rooms = snapshot.val();

          if (!rooms || Object.keys(rooms).length === 0) {
            roomList.innerHTML =
              '<div class="status-message info">No rooms available. Create one!</div>';
            return;
          }

          let roomsHtml = "";
          Object.entries(rooms).forEach(([roomId, room]) => {
            if (!room.gameStarted) {
              const playerCount = room.players
                ? Object.keys(room.players).length
                : 0;
              roomsHtml += `
                <div class="room-item">
                  <div class="room-info">
                    <h3>${room.name}</h3>
                    <p>${playerCount} player(s)</p>
                  </div>
                  <div style="display: flex; gap: 10px;">
                    <button onclick="joinRoom('${roomId}')">Join</button>
                    <button onclick="deleteRoom('${roomId}')" class="danger" style="width: auto; padding: 10px 16px;">Delete</button>
                  </div>
                </div>
              `;
            }
          });

          roomList.innerHTML =
            roomsHtml ||
            '<div class="status-message info">No rooms available. Create one!</div>';
        });
      }

      // Delete room
      window.deleteRoom = function (roomId) {
        if (confirm("Are you sure you want to delete this room?")) {
          roomsRef
            .child(roomId)
            .remove()
            .then(() => {
              console.log("Room deleted:", roomId);
            })
            .catch((error) => {
              console.error("Error deleting room:", error);
              alert("Failed to delete room");
            });
        }
      };

      // Remove player from room
      window.removePlayer = function (peerId) {
        if (!currentRoomId) return;

        if (confirm("Remove this player from the room?")) {
          roomsRef
            .child(currentRoomId)
            .child("players")
            .child(peerId)
            .remove()
            .then(() => {
              console.log("Player removed:", peerId);
            })
            .catch((error) => {
              console.error("Error removing player:", error);
              alert("Failed to remove player");
            });
        }
      };

      // Join room
      window.joinRoom = function (roomId) {
        const username = usernameInput.value.trim();
        if (!username) {
          alert("Please enter your name");
          return;
        }

        myUsername = username;
        currentRoomId = roomId;
        isHost = false;

        roomsRef
          .child(roomId)
          .once("value")
          .then((snapshot) => {
            const room = snapshot.val();
            if (!room) {
              alert("Room no longer exists");
              return;
            }

            // Add player to room
            roomsRef
              .child(roomId)
              .child("players")
              .child(myPeerId)
              .set({
                name: username,
                peerId: myPeerId,
                isHost: false,
                connected: true,
              })
              .then(() => {
                // Set presence tracking
                const playerPresenceRef = roomsRef
                  .child(roomId)
                  .child("players")
                  .child(myPeerId)
                  .child("connected");
                playerPresenceRef.onDisconnect().set(false);

                showLobby();
                watchRoom();
              });
          });
      };

      // Watch room for updates
      function watchRoom() {
        roomsRef.child(currentRoomId).on("value", (snapshot) => {
          const room = snapshot.val();
          if (!room) {
            alert("Room was closed");
            leaveRoom();
            return;
          }

          // Check if all players disconnected
          if (room.players) {
            const connectedPlayers = Object.values(room.players).filter(
              (p) => p.connected,
            );
            if (connectedPlayers.length === 0) {
              // Clean up empty room
              roomsRef.child(currentRoomId).remove();
              return;
            }
          }

          allPlayers = room.players || {};
          updatePlayerList(room.players);
          roomName.textContent = room.name;

          if (room.gameStarted && !gameState) {
            // Game started, load state from Firebase
            // This ensures all non-host players get the exact same game state
            gameState = room.gameState;
            if (gameState) {
              startGame();
            }
          }

          // Sync timer state
          if (gameState && room.timerRunning !== undefined) {
            if (room.timerRunning && !timerInterval) {
              // Timer should be running but isn't
              const elapsed = Math.floor(
                (Date.now() - room.timerStartTime) / 1000,
              );
              const remainingSeconds = Math.max(0, room.timerSeconds - elapsed);
              startTimerSync(remainingSeconds);
            } else if (!room.timerRunning && timerInterval) {
              // Timer should be stopped but is running
              stopTimer();
            }
          }
        });
      }

      // Update player list
      function updatePlayerList(players) {
        if (!players) return;

        let lobbyHtml = "";
        let gameHtml = "";

        Object.entries(players).forEach(([peerId, player]) => {
          // Lobby view with remove button (only show for host or if it's you)
          const canRemove = isHost || peerId === myPeerId;
          lobbyHtml += `<div class="player${player.isHost ? " host" : ""}">
            <span class="player-name">${player.name}</span>
            ${canRemove && !player.isHost ? `<button class="remove-btn" onclick="removePlayer('${peerId}')">Remove</button>` : ""}
          </div>`;

          // Game view without remove button
          gameHtml += `<div class="player${player.isHost ? " host" : ""}">${player.name}</div>`;
        });

        playerList.innerHTML = lobbyHtml;
        gamePlayers.innerHTML = gameHtml;
      }

      // Show lobby
      function showLobby() {
        homeScreen.classList.add("hidden");
        lobbyScreen.classList.remove("hidden");
        gameScreen.classList.add("hidden");
      }

      // Leave room
      leaveLobbyBtn.addEventListener("click", () => {
        leaveRoom();
      });

      function leaveRoom() {
        if (currentRoomId) {
          // Mark player as disconnected
          roomsRef
            .child(currentRoomId)
            .child("players")
            .child(myPeerId)
            .child("connected")
            .set(false);

          roomsRef.child(currentRoomId).off();
        }

        currentRoomId = null;
        isHost = false;
        gameState = null;

        homeScreen.classList.remove("hidden");
        lobbyScreen.classList.add("hidden");
        gameScreen.classList.add("hidden");
      }

      // Start game
      startGameBtn.addEventListener("click", () => {
        roomsRef
          .child(currentRoomId)
          .once("value")
          .then((snapshot) => {
            const room = snapshot.val();
            const players = Object.values(room.players);

            if (players.length < 3) {
              alert("Need at least 3 players to start!");
              return;
            }

            // Assign roles
            const location =
              GAME_LOCATIONS[Math.floor(Math.random() * GAME_LOCATIONS.length)];
            const spyIndex = Math.floor(Math.random() * players.length);

            const assignments = {};
            players.forEach((player, index) => {
              assignments[player.peerId] = {
                isSpy: index === spyIndex,
                location: index === spyIndex ? null : location.name,
                role:
                  index === spyIndex
                    ? null
                    : location.roles[index % location.roles.length],
              };
            });

            gameState = {
              location: location.name,
              assignments: assignments,
              duration: parseInt(gameDuration.value) * 60,
              startTime: Date.now(),
            };

            // Update Firebase - this will trigger watchRoom on all clients
            roomsRef
              .child(currentRoomId)
              .update({
                gameStarted: true,
                gameState: gameState,
              })
              .then(() => {
                // Only start game after Firebase confirms the update
                // This ensures all clients get the same state
                startGame();
              });
          });
      });

      // Start game screen
      function startGame() {
        homeScreen.classList.add("hidden");
        lobbyScreen.classList.add("hidden");
        gameScreen.classList.remove("hidden");

        // Show role
        const assignment = gameState.assignments[myPeerId];
        if (assignment.isSpy) {
          roleCard.className = "role-card spy";
          roleCard.innerHTML =
            "<h2>üïµÔ∏è You are the SPY!</h2><p>Find out the location without revealing yourself!</p>";
        } else {
          roleCard.className = "role-card";
          roleCard.innerHTML = `<h2>üìç Location: ${assignment.location}</h2><p>Role: ${assignment.role}</p>`;
        }

        // Show all locations
        locationsGrid.innerHTML = "";
        GAME_LOCATIONS.forEach((loc) => {
          const div = document.createElement("div");
          div.className = "location";
          div.textContent = loc.name;
          div.onclick = () => toggleLocation(div);
          locationsGrid.appendChild(div);
        });

        // Setup timer
        timerSeconds = gameState.duration;
        updateTimerDisplay();
      }

      // Toggle location crossed off
      function toggleLocation(element) {
        element.classList.toggle("crossed");
        const crossed = document.querySelectorAll(".location.crossed").length;
        locationCount.textContent = GAME_LOCATIONS.length - crossed;
      }

      // Timer functions
      startTimerBtn.addEventListener("click", () => {
        if (!timerInterval) {
          // Update Firebase with timer state
          roomsRef.child(currentRoomId).update({
            timerRunning: true,
            timerSeconds: timerSeconds,
            timerStartTime: Date.now(),
          });

          startTimerSync(timerSeconds);
        }
      });

      stopTimerBtn.addEventListener("click", () => {
        // Update Firebase
        roomsRef.child(currentRoomId).update({
          timerRunning: false,
          timerSeconds: timerSeconds,
        });

        stopTimer();
      });

      function startTimerSync(seconds) {
        if (timerInterval) return;

        timerSeconds = seconds;
        updateTimerDisplay();

        timerInterval = setInterval(() => {
          timerSeconds--;
          updateTimerDisplay();
          if (timerSeconds <= 0) {
            stopTimer();
            alert("Time is up!");
          }
        }, 1000);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
      }

      // End game
      endGameBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to end the game?")) {
          roomsRef.child(currentRoomId).update({
            gameStarted: false,
            gameState: null,
            timerRunning: false,
          });
          endGame();
        }
      });

      function endGame() {
        stopTimer();
        gameState = null;
        showLobby();
      }

      // Initialize
      initApp();
    </script>
  </body>
</html>
